# Agent Design and State Summary

This document summarizes the design, decisions, and current state of the `mollerdb` project as of the last interaction. It is intended to provide context for future AI agents or developers to seamlessly continue the work.

**Last Updated:** 2025-11-01 14:47:47 UTC
**Last User:** wdconinc

## 1. Project Goal

The primary goal is to create a high-performance, dual-language Software Development Kit (SDK) to provide convenient access to the MOLLER experiment's analysis database. This SDK is a key component of a larger strategy to improve data accessibility for collaborators who may not be proficient in SQL.

## 2. Core Design Decisions

### 2.1. Overall SDK Architecture
The SDK will support both C++ and Python users without duplicating core logic. The chosen architecture is:
- **C++ Core Library (`libmollerdb`)**: A central, high-performance C++ library that contains all database interaction logic.
- **Python Bindings**: A thin wrapper around the C++ core, exposing its functionality to Python.

### 2.2. Key Technologies
- **Build System**: `scikit-build-core` was chosen as the modern PEP 517 build backend. It will orchestrate the build process by invoking CMake. This replaces an earlier suggestion of using `setuptools` with a custom `CMakeBuild` class.
- **C++ Database Driver**: `libpqxx` is the designated library for connecting to and interacting with the PostgreSQL database from C++.
- **Python Bindings**: `pybind11` is the standard tool chosen to create the bindings between C++ and Python.
- **Data Interchange Format**: **Apache Arrow** was identified as the critical technology for efficient, zero-copy data transfer between the C++ core and Python. C++ functions will query the database and construct Arrow `Table` objects, which can be converted to Pandas DataFrames in Python with minimal overhead.

### 2.3. Naming and Structure
After some discussion, the following naming convention was finalized for consistency:
- **Repository**: `JeffersonLab/mollerdb`
- **Python Package Name**: `mollerdb`
- **Compiled Python Module**: `mollerdb` (This is the `.so` or `.pyd` file generated by `pybind11`).
- The final Python package structure will be located in `python/mollerdb/`.

## 3. Associated Database Schema Design

The SDK design was informed by a proposed redesign of the underlying database schema (`qwparity_schema.dbml`). Key schema suggestions include:
- **Unified Results Table**: Merging detector-specific tables (`md_data`, `lumi_data`, `beam`) into a single, flexible `results` table.
- **Generalized Sensitivities Table**: Abstracting "slopes" into a generic `sensitivities` table to store any linear correlation (detector-monitor, detector-detector, etc.). This requires a master `quantity` lookup table.
- **Versioning**: Adding versioning (e.g., `valid_from_run`, `valid_to_run`) to detector and quantity tables to ensure long-term reproducibility.

## 4. Current Status and Next Steps

**Status:** **Blocked by Agent Tool Failure.**

The complete file structure and content for the initial project skeleton have been defined and agreed upon. However, the agent's attempts to commit these files to the `JeffersonLab/mollerdb` repository have repeatedly failed due to a series of tool errors (`mcp_github_push_files`, `githubread`, etc.).

**The repository on GitHub is presumed to be empty or in an incorrect state.** The agent cannot verify its contents.

**Immediate Next Step:**
- **Action for User (`wdconinc`)**: Manually create the following files with their agreed-upon content in the `JeffersonLab/mollerdb` repository. This is necessary to unblock the project. The final agreed-upon file list and contents were provided in the last interaction before this summary was requested.

**Once the repository is populated, the project can proceed with:**
1.  **Implementing Core Logic**: Flesh out the `src/Database.cpp` file to perform actual database queries using `pqxx`.
2.  **Integrating Apache Arrow**: Add the logic to build Arrow `Table` objects from the `pqxx::result` and implement the C++-to-Python type conversions for these tables.
3.  **CI/CD Setup**: Create a GitHub Actions workflow to build and test the C++ and Python components on various platforms, ensuring all dependencies (`libpqxx`, `arrow`) are correctly handled.
4.  **Documentation and Examples**: Expand the `README.md` and add an `examples/` directory showing how to use the SDK in both Python and C++.
